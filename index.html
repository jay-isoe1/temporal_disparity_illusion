<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shadow Illusion — p5.js</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./style.css" />
  <style>
    /* Modern font stack: system UI + Arial fallback */
    body, details.explain-float {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* Floating glass card */
    details.explain-float {
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 9999;
      width: clamp(240px, 28vw, 360px);
      background: rgba(255, 255, 255, 0.75);
      color: #111;
      border: 1px solid rgba(255, 255, 255, 0.35);
      border-radius: 14px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.20);
      backdrop-filter: blur(10px) saturate(140%);
      -webkit-backdrop-filter: blur(10px) saturate(140%);
      overflow: hidden;
      transition: box-shadow .25s ease, transform .25s ease, opacity .25s ease;
      user-select: none;
    }
    details.explain-float:hover { box-shadow: 0 18px 36px rgba(0,0,0,0.24); }

    /* Header / drag handle */
    details.explain-float summary {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: grab;
      padding: 10px 12px;
      font-weight: 600;
      background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.35));
    }
    details.explain-float summary:active { cursor: grabbing; }
    details.explain-float summary::-webkit-details-marker { display: none; }
    .dot { width: 8px; height: 8px; border-radius: 999px; background: #111; opacity: .65; }

    /* Body */
    .explain-body {
      padding: 12px 14px 14px;
      font-size: 0.85rem;
      line-height: 1.45;
      max-height: min(64vh, 520px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      user-select: text;
    }
    .explain-body h3 { margin: 8px 0 4px; font-size: 0.95rem; font-weight: 600; }
    .explain-body p { margin: 6px 0; }

    /* Collapsed chip look */
    details.explain-float:not([open]) { opacity: 0.9; width: auto; }
    details.explain-float:not([open]) summary {
      padding: 8px 10px;
      background: rgba(255,255,255,.6);
    }
    details.explain-float:not([open]) .explain-body { display: none; }
  </style>
</head>
<body>
  <main id="app">
    <!-- Collapsed by default -->
    <details class="explain-float" id="explainCard">
      <summary id="explainHandle">
        <span class="dot"></span>
        Explanation
      </summary>
      <div class="explain-body">
        <h3>1) Layout & Math</h3>
        <p>\[
          \theta_i = i\,\Delta\theta,\quad
          r_i = r_{\text{start}} + i\,\Delta r,\quad
          x_i = x_c + r_i\cos\theta_i,\quad
          y_i = y_c + r_i\sin\theta_i.
        \]</p>

        <h3>2) Wave Layout</h3>
        <p>\[
          k=\frac{2\pi\cdot 4}{\text{cols}},\quad
          y_{\text{offset}}=A\sin(k\cdot \text{col})
        \]</p>

        <h3>3) Lightness Mapping</h3>
        <p>\[
          t=\frac{\text{col}}{\text{cols}-1},\quad
          L=
          \begin{cases}
            30 & t<0.25\\
            50 & 0.25\le t<0.50\\
            70 & 0.50\le t<0.75\\
            90 & 0.75\le t\le 1
          \end{cases}
        \]</p>

        <h3>4) Shadow Phase & Flip</h3>
        <p>\[
          \text{shadowShiftPhase} \leftarrow
          \mathrm{lerp}(\text{shadowShiftPhase},\ \pm 1,\ \text{shadowShiftSpeed})
        \]</p>
        <p>Flips polarity when <code>fadeDirection</code> reverses.</p>

        <h3>5) Layout + Shadow Modes</h3>
        <p>
          <strong>Layout</strong> (<code>spiralModeIndex</code>) decides shape positions (Linear, Golden, Double, Wave).
          <br><strong>Shadow</strong> (<code>shadowModeIndex</code>) decides black/white sides 
          (Horizontal, Angular, Rotation-based, Eye-based, Wave).
        </p>
        <ul>
          <li><strong>Wave + Wave:</strong> synchronized shadows → smooth flow.</li>
          <li><strong>Wave + Horizontal:</strong> horizontal stripes across wavy layout.</li>
          <li><strong>Linear + Angular:</strong> radial flips based on polar angle.</li>
        </ul>
        <p><em>Tip:</em> Pairing Wave layout with Wave shadow gives the clearest illusion.</p>
      </div>
    </details>

    <div id="canvas-wrap"></div>
  </main>

  <!-- p5.js + dat.GUI + MathJax -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.3/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dat.gui@0.7.9/build/dat.gui.min.js"></script>
  <script src="sketch.js"></script>
  <script>
    window.MathJax = { tex: { inlineMath: [['\\(','\\)'], ['$', '$']] }, svg: { fontCache: 'global' } };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <!-- Drag behavior -->
  <script>
    (() => {
      const card = document.getElementById('explainCard');
      const handle = document.getElementById('explainHandle');
      let dragging = false, startX = 0, startY = 0, startLeft = 16, startTop = 16;

      const onDown = (e) => {
        if (e.type === 'mousedown' && e.button !== 0) return;
        dragging = true;
        handle.style.cursor = 'grabbing';
        const rect = card.getBoundingClientRect();
        startLeft = rect.left + window.scrollX;
        startTop  = rect.top  + window.scrollY;
        const point = (e.touches && e.touches[0]) || e;
        startX = point.clientX + window.scrollX;
        startY = point.clientY + window.scrollY;
        e.preventDefault();
      };
      const onMove = (e) => {
        if (!dragging) return;
        const point = (e.touches && e.touches[0]) || e;
        card.style.left = startLeft + (point.clientX + window.scrollX - startX) + 'px';
        card.style.top  = startTop  + (point.clientY + window.scrollY - startY) + 'px';
      };
      const onUp = () => { dragging = false; handle.style.cursor = 'grab'; };

      handle.addEventListener('mousedown', onDown, { passive: false });
      window.addEventListener('mousemove', onMove, { passive: false });
      window.addEventListener('mouseup', onUp, { passive: true });
      handle.addEventListener('touchstart', onDown, { passive: false });
      window.addEventListener('touchmove', onMove, { passive: false });
      window.addEventListener('touchend', onUp, { passive: true });
    })();
  </script>
</body>
</html>
